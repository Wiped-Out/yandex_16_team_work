# Отчет
## Генерация данных

Для генерации данных был подготовлен [скрипт](data_generator.py) который:

- генерирует 100 000 идентификаторов фильмов;
- генерирует 100 000 идентификаторов пользователей;
    
    Для каждого пользователя:
    
    - до 20 оценок к фильмам (likes);
    - до 20 закладок (bookmarks);
    - до 10 рецензий к фильмам (reviews).

Сгенерированные данные сохраняются в файлы формата `json` для последующей загрузки в тестируемое хранилище.

## Базы данных

![MongoDb vs PostgreSQL](https://scdn1.plesk.com/wp-content/uploads/2021/07/23084226/HEADER-blog_MongoDB-vs-PostgreSQL.png)

Для сравнения выбраны:

- PostgreSQL
- MongoDB

Для тестирования были использованы образы на основе docker-контейнеров:

- mongo:6.0.1
- postgres:14.2

## Тестирование записи

1. Загрузка в хранилище **MongoDB** производилась при помощи python-скрипта ([data_loader_mongodb.py](data_loader_mongodb.py)) с использованием синхронной библиотеки `pymongo`. Время загрузки -  89.8 с.
2. Загрузка в хранилище **PostgreSQL** производилась при помощи python-скрипта ([data_loader_postgresql.py](data_loader_postgresql.py)) с использованием асинхронной библиотеки `asyncpg`. Время загрузки -  98.13 с.

## Тестирование чтения

### Кейсы проверки чтения уже загруженных данных

1. Cписок понравившихся пользователю фильмов (список лайков пользователя);
2. Cписок закладок;
3. Cредняя пользовательская оценка фильма.

Для тестирования чтения их хранилищ с использованием выше-описанных кейсов были разработаны python-скрипты: data_reader_mongodb.py и data_reader_postgresql.py.

### Алгоритм тестирования

Из сгенерированных данных (файлов `json`) делается случайным образом выборка из 100 идентификаторов пользователей и 100 идентификаторов фильмов. Для каждого идентификатора пользователя из выборки выполняется запрос на список лайков пользователя и на список закладок пользователя. Для каждого идентификатора фильма из выборки выполняется запрос на среднюю пользовательскую оценку фильма.

Скрипт для тестирования чтения их хранилища **MongoDB** ([data_reader_mongodb.py](data_reader_mongodb.py)) разработан с использованием асинхронной библиотеки `motor`

Скрипт для тестирования чтения их хранилища **PostgreSQL** ([data_reader_postgresql.py](data_reader_postgresql.py)) разработан с использованием асинхронной библиотеки `asyncpg`

## Результаты

### MongoDB

- Список лайков: 42.27 с
- Список закладок: 54.08 с
- Средняя оценка: 40.12 с
- Все запросы: 138.76 c

### PostgreSQL

- Список лайков:  1.29 с
- Список закладок: 1.43 с
- Средняя оценка: 7.84 с
- Все запросы: 7.95 с

Результаты печальные для **MongoBD**

Обратившись с сайту, содержащему все знания мира ([google](https://www.google.com/)), была выдвинута теория - посмотреть что там с индексами. И оказалось, что если создать индексы на требуемые запросы:

```python
db.likes.createIndex({user_id: 1})
db.bookmarks.createIndex({user_id: 1})
db.likes.createIndex({film_id: 1, rating: 1})
```

то ситуация меняется:

### MongoDB (с индексами)

- Список лайков: 0.30 с
- Список закладок: 0.35 с
- Средняя оценка: 0.36 с
- Все запросы: 0.68 c